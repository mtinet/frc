<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRC Display Controller - Control Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #fff; height: 100vh; overflow: hidden; }
        .container { display: flex; flex-direction: column; height: 100vh; }
        .header { background: #2d2d2d; padding: 15px 20px; border-bottom: 2px solid #667eea; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5em; color: #667eea; }
        
        .main-layout { display: grid; grid-template-columns: 280px 1fr auto 1fr; gap: 2px; flex: 1; background: #1a1a1a; overflow: hidden; }
        .panel { background: #2d2d2d; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { background: #1a1a1a; padding: 12px 15px; border-bottom: 1px solid #444; font-weight: bold; color: #667eea; font-size: 0.9em; }
        .panel-content { flex: 1; overflow-y: auto; padding: 15px; }

        /* ÌååÏùº Î∏åÎùºÏö∞Ï†Ä */
        .file-tabs { display: flex; gap: 2px; margin-bottom: 10px; }
        .file-tab { flex: 1; padding: 8px; background: #1a1a1a; border: none; color: #999; cursor: pointer; font-size: 0.85em; }
        .file-tab.active { background: #667eea; color: #fff; }
        .file-list { display: flex; flex-direction: column; gap: 8px; }
        .file-item { background: #333; padding: 10px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px; border: 2px solid transparent; }
        .file-item:hover { background: #3a3a3a; border-color: #667eea; }
        .file-item.active { background: #667eea; }
        .file-thumbnail { width: 50px; height: 35px; object-fit: cover; border-radius: 3px; background: #000; }
        .file-name { font-size: 0.85em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Î∑∞Ïñ¥ */
        .preview-container, .program-container { background: #000; position: relative; }
        .view-label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 4px 8px; border-radius: 3px; font-size: 0.7em; z-index: 10; }
        .preview-label { color: #f39c12; }
        .program-label { color: #27ae60; }
        .view-content { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }

        .cut-panel { background: #1a1a1a; display: flex; align-items: center; justify-content: center; padding: 0 10px; }
        .btn-cut { background: #f39c12; color: white; padding: 20px 10px; font-size: 1.2em; font-weight: bold; border-radius: 5px; border: none; cursor: pointer; writing-mode: vertical-rl; text-orientation: upright; height: 150px; }
        .btn-cut:hover { background: #e67e22; }

        /* ÌïòÎã® Ï†úÏñ¥Ìåê */
        .score-panel { background: #252525; padding: 15px; border-top: 2px solid #444; }
        .score-section { display: flex; justify-content: space-around; gap: 20px; margin-bottom: 10px; }
        .team-score { flex: 1; background: #333; padding: 10px; border-radius: 8px; text-align: center; }
        .team-score input[type="text"] { width: 90%; background: transparent; border: none; border-bottom: 1px solid #555; color: #fff; text-align: center; font-size: 1.1em; margin-bottom: 5px; }
        .score-display { font-size: 2.5em; font-weight: bold; color: #667eea; margin: 5px 0; }
        .score-controls { display: flex; justify-content: center; gap: 5px; }
        
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-primary { background: #667eea; }
        .btn-success { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        .btn-info { background: #3498db; }

        .youtube-input-section { display: flex; gap: 10px; padding: 10px; background: #1a1a1a; border-radius: 5px; }
        .youtube-input-section input { flex: 1; background: #333; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÅ FRC Display Controller</h1>
            <a href="/view" target="_blank" class="btn btn-info">üñ•Ô∏è Î∑∞Î∞ïÏä§ Ïó¥Í∏∞</a>
        </div>

        <div class="main-layout">
            <div class="panel file-browser">
                <div class="panel-header">üìÅ ÎØ∏ÎîîÏñ¥ ÌååÏùº</div>
                <div class="panel-content">
                    <div class="file-tabs">
                        <button class="file-tab active" id="tab-all" onclick="switchFileTab('all')">Ï†ÑÏ≤¥</button>
                        <button class="file-tab" id="tab-images" onclick="switchFileTab('images')">Ïù¥ÎØ∏ÏßÄ</button>
                        <button class="file-tab" id="tab-videos" onclick="switchFileTab('videos')">ÎèôÏòÅÏÉÅ</button>
                    </div>
                    <div class="file-list" id="file-list"></div>
                </div>
            </div>

            <div class="panel preview-container">
                <span class="view-label preview-label">ÎØ∏Î¶¨Î≥¥Í∏∞ (PREVIEW)</span>
                <div class="view-content" id="preview-content"></div>
            </div>

            <div class="cut-panel">
                <button class="btn-cut" onclick="cutToProgram()">CUT</button>
            </div>

            <div class="panel program-container">
                <span class="view-label program-label">ÌîÑÎ°úÍ∑∏Îû® (PROGRAM)</span>
                <div class="view-content" id="program-content"></div>
            </div>
        </div>

        <div class="score-panel">
            <div class="score-section">
                <div class="team-score">
                    <input type="text" id="team1-name" onchange="updateTeamName(1, this.value)">
                    <div class="score-display" id="score1">0</div>
                    <div class="score-controls">
                        <button class="btn btn-danger" onclick="changeScore(1, -1)">-1</button>
                        <button class="btn btn-danger" onclick="changeScore(1, -5)">-5</button>
                        <button class="btn btn-success" onclick="changeScore(1, 5)">+5</button>
                        <button class="btn btn-success" onclick="changeScore(1, 1)">+1</button>
                    </div>
                    <input type="number" class="btn" style="width:120px; background:#222; margin-top:5px;" placeholder="ÏûÖÎ†•" onchange="setScore(1, this.value)">
                </div>
                <div class="team-score">
                    <input type="text" id="team2-name" onchange="updateTeamName(2, this.value)">
                    <div class="score-display" id="score2">0</div>
                    <div class="score-controls">
                        <button class="btn btn-danger" onclick="changeScore(2, -1)">-1</button>
                        <button class="btn btn-danger" onclick="changeScore(2, -5)">-5</button>
                        <button class="btn btn-success" onclick="changeScore(2, 5)">+5</button>
                        <button class="btn btn-success" onclick="changeScore(2, 1)">+1</button>
                    </div>
                    <input type="number" class="btn" style="width:120px; background:#222; margin-top:5px;" placeholder="ÏûÖÎ†•" onchange="setScore(2, this.value)">
                </div>
            </div>
            <div class="youtube-input-section">
                <input type="text" id="youtube-url" placeholder="Ïú†ÌäúÎ∏å URL ÏûÖÎ†•">
                <button class="btn btn-primary" onclick="loadYouTube()">ÏòÅÏÉÅ Î°úÎìú</button>
                <button class="btn btn-danger" onclick="clearPreview()">ÏßÄÏö∞Í∏∞</button>
            </div>
        </div>
    </div>

    <script>
        let currentState = { score: {}, preview_media: {}, current_media: {} };
        let previousState = { preview_media: {}, current_media: {} };
        let currentTab = 'all';

        async function syncState() {
            try {
                const res = await fetch('/api/state');
                currentState = await res.json();
                updateUI();
            } catch (e) { console.error(e); }
        }

        function updateUI() {
            document.getElementById('score1').textContent = currentState.score.team1;
            document.getElementById('score2').textContent = currentState.score.team2;
            const n1 = document.getElementById('team1-name');
            const n2 = document.getElementById('team2-name');
            if (document.activeElement !== n1) n1.value = currentState.score.team1_name;
            if (document.activeElement !== n2) n2.value = currentState.score.team2_name;

            renderMedia('preview-content', currentState.preview_media, previousState.preview_media, true);
            renderMedia('program-content', currentState.current_media, previousState.current_media, false);
        }

        function renderMedia(containerId, media, prevMedia, isPreview) {
            if (media.type === prevMedia.type && media.url === prevMedia.url && media.youtube_id === prevMedia.youtube_id) return;
            
            const container = document.getElementById(containerId);
            if (media.type === 'youtube') {
                const mute = isPreview ? 1 : 1; // ÌîÑÎ°úÍ∑∏Îû® Ï∞ΩÏùÄ Ìï≠ÏÉÅ ÏùåÏÜåÍ±∞ (ÏÇ¨Ïö©Ïûê ÏöîÏ≤≠ Î∞òÏòÅ)
                container.innerHTML = `<iframe src="https://www.youtube.com/embed/${media.youtube_id}?autoplay=1&mute=${mute}" style="width:100%;height:100%" frameborder="0" allow="autoplay; encrypted-media"></iframe>`;
            } else if (media.type === 'video') {
                container.innerHTML = `<video src="${media.url}" autoplay muted loop style="width:100%;height:100%;object-fit:contain"></video>`;
            } else if (media.type === 'image') {
                container.innerHTML = `<img src="${media.url}" style="max-width:100%;max-height:100%;object-fit:contain">`;
            } else {
                container.innerHTML = '<div style="color:#444">ÎØ∏ÎîîÏñ¥ ÏóÜÏùå</div>';
            }
            
            if (isPreview) previousState.preview_media = JSON.parse(JSON.stringify(media));
            else previousState.current_media = JSON.parse(JSON.stringify(media));
        }

        async function switchFileTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.file-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            loadFiles();
        }

        async function loadFiles() {
            const res = await fetch('/api/files?type=' + currentTab);
            const data = await res.json();
            const list = document.getElementById('file-list');
            list.innerHTML = data.files.map(f => `
                <div class="file-item" onclick="setPreviewMedia('${f.type}', '${f.filename}')">
                    ${f.type === 'image' ? `<img src="${f.url}" class="file-thumbnail">` : '<div class="file-thumbnail" style="display:flex;align-items:center;justify-content:center">üé¨</div>'}
                    <div class="file-name">${f.filename}</div>
                </div>
            `).join('');
        }

        async function setPreviewMedia(type, filename) {
            await fetch('/api/preview-media', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type, filename})
            });
            syncState();
        }

        async function changeScore(team, delta) {
            const key = `team${team}`;
            const newScore = Math.max(0, currentState.score[key] + delta);
            await fetch('/api/state', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({score: {[key]: newScore}}) });
            syncState();
        }

        async function setScore(team, val) {
            const key = `team${team}`;
            await fetch('/api/state', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({score: {[key]: parseInt(val) || 0}}) });
            syncState();
        }

        async function updateTeamName(team, name) {
            const key = `team${team}_name`;
            await fetch('/api/state', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({score: {[key]: name}}) });
            syncState();
        }

        async function loadYouTube() {
            const url = document.getElementById('youtube-url').value;
            await fetch('/api/youtube', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({url}) });
            syncState();
        }

        async function cutToProgram() {
            await fetch('/api/cut', { method: 'POST' });
            syncState();
        }

        async function clearPreview() {
            await fetch('/api/clear-media', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({target: 'preview'}) });
            document.getElementById('youtube-url').value = '';
            syncState();
        }

        loadFiles();
        setInterval(syncState, 1000);
    </script>
</body>
</html>